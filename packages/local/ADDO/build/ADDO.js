Ext.define("ADDO.admin.ux.plugin.RowExpander",{extend:"Ext.grid.plugin.RowExpander",alias:"plugin.uxadmin-rowexpander",rowBodyTpl:['<div class="text-wrapper">','<div class="thread-data">','<div class="thread-paragraph">{details}</div>','<div class="thread-toggle collapse"><span>COLLAPSE</span><img src="resources/icons/collapse-thread.png"></div>',"</div>","</div>"],addExpander:Ext.emptyFn,addCollapsedCls:{fn:function(b,a,c){var d=this.rowExpander;if(!d.recordsExpanded[a.record.internalId]){a.itemClasses.push(d.rowCollapsedCls)}else{a.itemClasses.push("x-grid-row-expanded")}this.nextTpl.applyOut(a,b,c)},syncRowHeights:function(a,b){this.rowExpander.syncRowHeights(a,b)},priority:20000}});Ext.define("ADDO.newticket.NewTicketWindowController",{extend:"Ext.app.ViewController",alias:"controller.newticketwindow",onSubmitClick:function(){var h=this,j=h.getReferences(),c=this.getView(),i=j.subject.getValue(),l=j.description.getValue(),b=j.category.getValue(),k=j.priority.getValue(),d=Ext.ComponentQuery.query("ticketadmingrid")[0],a=Ext.ComponentQuery.query("ticketadminpanel")[0],g=d.getViewModel(),f=g.get("TicketAdminStore"),e;e={addo_supportusers_id:0,addo_ticket_category_id:b,addo_ticket_priority_id:k,addo_ticket_status_id:1000001,tags:"tweeeeet",subject:i,details:l,attachments:""};Ext.Ajax.request({url:"/ticket",scope:h,method:"POST",jsonData:e,success:function(m){var n=Ext.decode(m.responseText);f.add(n.data[0]);c.hide();a.setActiveItem(0)},failure:function(m){var n=Ext.decode(m.responseText);Ext.toast(n.message,"Error","t")}})}});Ext.define("ADDO.newticket.NewTicketWindow",{extend:"Ext.window.Window",alias:"widget.newticketwindow",requires:["ADDO.newticket.NewTicketWindowController"],controller:"newticketwindow",viewModel:{type:"newticketwindow"},autoShow:true,height:"74%",width:"90%",padding:20,layout:"fit",title:"New Ticket",border:false,closable:true,draggable:false,bodyBorder:false,resizable:false,cls:"panelbody",message:"",info:false,modal:true,items:[{width:"100%",height:"100%",items:[{xtype:"textfield",fieldLabel:"Subject",reference:"subject",labelAlign:"top",width:"100%",name:"subject",labelSeparator:" ",cls:"newticket-textfield-cls",emptyText:"Subject"},{xtype:"htmleditor",reference:"description",cls:"ticket-htmleditor-cls",width:"100%",height:"60%",name:"textBody"},{layout:"hbox",cls:"panelbody",defaults:{cls:"rounded"},items:[{xtype:"combo",reference:"category",queryMode:"local",displayField:"name",valueField:"addo_ticket_category_id",store:"category",emptyText:"(select category)",padding:"0 18 0 0",cls:"rounded"},{xtype:"combo",reference:"priority",queryMode:"local",displayField:"name",valueField:"addo_ticket_priority_id",store:"priority",emptyText:"(select priority)"},{xtype:"button",cls:"transparent-button",iconCls:"x-fa fa-paperclip",text:"attach a file",margin:"0 0 0 700"}]},{xtype:"button",text:"Submit",cls:"rounded",margin:"10 0 0 0",handler:"onSubmitClick"}]}]});Ext.define("ADDO.newticket.NewTicketWindowModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.newticketwindow"});Ext.define("ADDO.store.Category",{extend:"Ext.data.Store",alias:"store.category",storeId:"category",autoLoad:true,proxy:{type:"ajax",url:"/priorityandcategory/category",reader:{type:"json",rootProperty:"data"}}});Ext.define("ADDO.store.Priority",{extend:"Ext.data.Store",alias:"store.priority",storeId:"priority",autoLoad:true,proxy:{type:"ajax",url:"/priorityandcategory/priority",reader:{type:"json",rootProperty:"data"}}});Ext.define("ADDO.store.SupportUser",{extend:"Ext.data.Store",alias:"store.supportuser",storeId:"supportuser",autoLoad:true,proxy:{type:"ajax",url:"/supportuser",reader:{type:"json",rootProperty:"data"}}});Ext.define("ADDO.thread.CommentsGrid",{extend:"Ext.grid.Panel",alias:"widget.commentsgrid",cls:"commentsgrid",hideHeaders:true,margin:20,columns:[{dataIndex:"comments",flex:1,renderer:"renderTitleColumn"}],titleTpl:['<div class="text-wrapper"><div class="comments-data"><div class="comments-picture"><img src="{comment_image}"></div><div class="comments-content"><div class="anchor"></div><div class="comments-author">{comment_name}</div><div class="comments-text">{comment}</div></div><div class="comments-icon"><img src="resources/icons/clock-icon.png">{[this.getDateFormat(values,"Y-m-d H:i:s")]}</div></div><div>',{getDateFormat:function(a,b){return Ext.Date.format(a.date,b)}}]});Ext.define("ADDO.thread.EditorPanel",{extend:"Ext.panel.Panel",alias:"widget.editorpanel",margin:"0 20 20 20",layout:"fit",bbar:[{text:"Reply",handler:"onClickReply"},{text:"Cancel",handler:"onClickCancel"}],items:[{xtype:"htmleditor"}]});Ext.define("ADDO.thread.ThreadPanel",{extend:"Ext.grid.Panel",alias:"widget.threadpanel",requires:["Ext.grid.plugin.RowExpander"],cls:"threadpanel",hideHeaders:true,scrollable:"y",margin:20,bbar:[{xtype:"component",reference:"reply",width:"100%",padding:10,componentCls:"ticket-reply",html:"ïƒ¥ Reply",listeners:{afterrender:"onReplyCmpRender"}}],columns:[{dataIndex:"subject",flex:1,renderer:"renderThreadDescription"}],viewConfig:{listeners:{itemclick:"onThreadClick",expandbody:"onExpandBody",collapsebody:"onCollapseBody"}},plugins:[{ptype:"uxadmin-rowexpander",pluginId:"rowexpander"}],titleTpl:['<div class="text-wrapper"><div class="thread-data"><div class="thread-picture"><img src="{[this.getProfileImg(values)]}"></div><div class="thread-content"><div class="thread-title">{subject}</div><div class="thread-small">by <span class="thread-author">{[this.getAuthor(values)]}</span><img src="resources/icons/cal-icon.png"/>{[this.getDateFormat(values,"d-m-Y")]}<img src="resources/icons/clock-icon.png"/>{[this.getDateFormat(values,"H:i:s")]}</div><div class="thread-paragraph thread-paragraph-simple" {expanded}>{details:ellipsis(600, true)}</div><div class="thread-toggle expand" {expanded}><span>EXPAND</span><img src="resources/icons/expand-thread.png"></div></div></div><div>',{getProfileImg:function(a){return Utility.profileImg()},getAuthor:function(b){var d=Ext.getStore("login"),c=d.getAt(0),a=c.data;return a.fullname},getDateFormat:function(a,b){return Ext.Date.format(a.created,b)}}]});Ext.define("ADDO.thread.TicketDetails",{extend:"Ext.form.Panel",alias:"widget.ticketdetails",padding:10,border:false,defaults:{padding:"10 0 0 15"},title:"DETAILS",dockedItems:[{xtype:"toolbar",style:{background:"#fff"},dock:"bottom",items:["->",{text:"SUBMIT",handler:"onSubmitClick"}]}],items:[{xtype:"combo",fieldLabel:"Priority",name:"addo_ticket_priority_id",queryMode:"local",displayField:"name",valueField:"addo_ticket_priority_id",store:"priority",triggerAction:"all",bind:{value:"{addo_ticket_priority_id}"},editable:false},{xtype:"combo",fieldLabel:"Category",name:"addo_ticket_category_id",queryMode:"local",displayField:"name",valueField:"addo_ticket_category_id",store:"category",triggerAction:"all",bind:{value:"{addo_ticket_category_id}"},editable:false},{xtype:"textfield",fieldLabel:"From",bind:{value:"{fromname}"},name:"fromname"},{xtype:"combo",fieldLabel:"Assigned To",name:"addo_supportusers_id",store:"supportuser",queryMode:"local",bind:{value:"{addo_supportusers_id}"},valueField:"addo_supportusers_id",displayField:"fullname",triggerAction:"all",editable:false},{xtype:"datefield",fieldLabel:"Date",bind:{value:"{created}"},name:"created"},{xtype:"datefield",fieldLabel:"Due",bind:{value:"{duedate}"},name:"duedate"},{xtype:"numberfield",fieldLabel:"Time Spent",name:"timeSpent"},{xtype:"textfield",fieldLabel:"Start Date",name:"startdate",bind:{value:"{startdate}"},editable:false},{xtype:"datefield",fieldLabel:"Close Date",bind:{value:"{closedate}"},name:"closedate"},{xtype:"textfield",fieldLabel:"Tags",bind:{value:"{tags}"},name:"tags"}]});Ext.define("ADDO.thread.TicketsThreadViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.ticketsthreadview",data:{},stores:{threadstore:{fields:[{name:"tickethistoryid",type:"number"},{name:"subject",type:"string"},{name:"comment",type:"string"},{name:"fromname",type:"string"},{name:"date",type:"date"},{name:"comment_name",type:"string"},{name:"comment_image",type:"string"},{name:"details",type:"string"}],filters:[{filterFn:function(a){return a.data.comment_name.length>0}}],proxy:{type:"ajax",url:"/tickethistory",reader:{type:"json",rootProperty:"data"}},sorters:[{property:"tickethistoryid",direction:"DESC"}],autoLoad:false},panelstore:{fields:["addo_supportusers_id","addo_ticket_category_id","addo_ticket_priority_id","addo_ticket_status_id","addo_tickets_id","attachments","author_id",{name:"created",type:"date",dateFormat:"Y-m-d H:i:s"},"details","fromemail","fromname","id","subject","tags","ticket_category_name","ticket_priority_name","ticket_status_name"],data:[]}}});Ext.define("ADDO.thread.TicketsThreadViewController",{extend:"Ext.app.ViewController",alias:"controller.ticketsthread",control:{ticketsthreadview:{cleardirty:"removeTicketDetailsFormDirty"}},removeTicketDetailsFormDirty:function(){var b=this.getReferences(),a=b.ticketdetails},onReplyCmpRender:function(c,a){var b=this;bodyEl=c.getEl();bodyEl.on("click",b.onReplyCmpClick,b)},renderThreadDescription:function(i,b,d){var h=this.getView(),g=h.getReferences(),a=g.threadpanel,e=a.getPlugin("rowexpander"),f=a.titleTpl;if(!f.isTemplate){a.titleTpl=f=new Ext.XTemplate(f)}var c=Ext.Object.chain(d.data);c.expanded=e.recordsExpanded[d.internalId]?' style="display: none"':"";return f.apply(c)},onThreadClick:function(b,c,j,f,g){if(g.getTarget(".thread-toggle")){var i=this.getView(),h=i.getReferences(),a=h.threadpanel,d=a.getPlugin("rowexpander");d.toggleRow(f,c)}},onExpandBody:function(a){Ext.fly(a).addCls("x-grid-row-expanded");Ext.fly(a).down(".thread-paragraph-simple").enableDisplayMode().hide();Ext.fly(a).down(".expand").enableDisplayMode().hide()},onCollapseBody:function(a){Ext.fly(a).removeCls("x-grid-row-expanded");Ext.fly(a).down(".thread-paragraph-simple").enableDisplayMode().show();Ext.fly(a).down(".expand").enableDisplayMode().show()},renderTitleColumn:function(h,c,b){var a=this.getView(),d=a.getReferences(),f=d.commentsgrid,e=f.titleTpl;if(!e.isTemplate){f.titleTpl=e=new Ext.XTemplate(e)}var g=Ext.Object.chain(b.data);return e.apply(g)},onReplyCmpClick:function(c){var a=this.getView(),b=a.getReferences();b.editorpanel.setHidden(false);b.reply.setHidden(true)},onClickReply:function(a){var j=this;var l=this.getView(),k=l.getReferences(),i=k.editorpanel.items.items[0],m=this.getViewModel(),d=m.get("threadstore"),f="",b="",h="";h=new Date();b=(h.getMonth()+1)+"/"+h.getDate()+"/"+h.getFullYear();f={id:d.getCount()+1,createdby:"Test User",image:"photo-1.png",comment:i.value,date:b.toString()};var g=i.value;if(i.value!=""){i.setValue("");k.editorpanel.setHidden(true);k.reply.setHidden(false)}var c={addo_tickets_id:m.getData().addo_tickets_id,details:g,attachments:"",addo_supportusers_id:m.getData().addo_supportusers_id},e={addo_tickets_id:m.getData().addo_tickets_id};Ext.Ajax.request({url:"/tickethistory",method:"post",params:c,scope:j,success:function(n){Ext.apply(d.getProxy().extraParams,e);d.load()},failure:function(){}})},onClickCancel:function(c){var a=this.getView(),b=a.getReferences();b.editorpanel.setHidden(true);b.reply.setHidden(false)},onSubmitClick:function(){var d=this.getReferences(),a=d.ticketdetails,c=a.up("ticketsthreadview"),b=c.getViewModel(),f=a.getForm(),e=f.getValues(false,true);if(a.isDirty()){Ext.Ajax.request({url:"/ticket",method:"PUT",jsonData:{addo_tickets_id:b.get("addo_tickets_id")},params:e,success:function(){a.up("ticketsthreadview").fireEvent("cleardirty")},failure:function(){}})}},onTakeOverClick:function(){var f=this.getReferences(),a=f.ticketdetails,e=a.up("ticketsthreadview"),d=e.getViewModel(),c=a.down("combo[name=addo_supportusers_id]").getValue(),g=Ext.getStore("loginstore"),b=g.data.items[0].data.supportuserid;if(c!=b){Ext.Ajax.request({url:"/ticket",method:"PUT",jsonData:{addo_tickets_id:d.get("addo_tickets_id")},params:{addo_supportusers_id:b},success:function(){d.set("addo_supportusers_id",b);d.notify();a.up("ticketsthreadview").fireEvent("cleardirty")},failure:function(){}})}},onBackBttonClick:function(a){a.up("ticketadminpanel").setActiveItem(0)}});Ext.define("ADDO.thread.TicketsThreadView",{extend:"Ext.container.Container",alias:"widget.ticketsthreadview",requires:["ADDO.thread.ThreadPanel","ADDO.thread.EditorPanel","ADDO.thread.CommentsGrid","ADDO.thread.TicketsThreadViewModel","ADDO.thread.TicketsThreadViewController"],width:"100%",controller:"ticketsthread",viewModel:{type:"ticketsthreadview"},cls:"noscrollbar",layout:{type:"vbox",pack:"right",align:"right"},scrollable:"y",height:800,items:[{xtype:"toolbar",width:"100%",cls:"ticket-toolbar-cls",items:[{xtype:"tbfill"},{xtype:"button",cls:"ticket-btn",margin:"10px 0px 0px 0px",text:"Back",handler:"onBackBttonClick"}]},{xtype:"container",width:"100%",layout:{type:"vbox",align:"stretch"},items:[{xtype:"threadpanel",reference:"threadpanel",bind:{store:"{panelstore}"}},{xtype:"editorpanel",reference:"editorpanel",hidden:true,height:200},{xtype:"commentsgrid",reference:"commentsgrid",bind:{store:"{threadstore}"}}]}]});Ext.define("ADDO.ticketadmin.TicketAdminGridModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.ticketadmingrid",stores:{TicketAdminStore:{autoLoad:true,fields:["addo_supportusers_id","addo_ticket_category_id","addo_ticket_priority_id","addo_ticket_status_id","addo_tickets_id","attachments","author_id","details","fromemail","fromname","subject","tags","ticket_category_name","ticket_priority_name","ticket_status_name",{name:"created",type:"date"}],proxy:{type:"ajax",url:"/ticket",reader:{type:"json",rootProperty:"data"}}}}});Ext.define("ADDO.ticketadmin.TicketAdminGridController",{extend:"Ext.app.ViewController",alias:"controller.ticketadmingrid",init:function(){Ext.create("ADDO.store.Category",{});Ext.create("ADDO.store.Priority",{});Ext.create("ADDO.store.SupportUser",{})},onTicketClick:function(){Ext.widget("newticketwindow",{})},onCellClick:function(a,f,j,m,h,i){var c=a.up("ticketadminpanel"),k=this,b=c.down("ticketsthreadview"),o=b.getViewModel(),n=b.down("ticketdetails"),d={addo_tickets_id:f.data.addo_tickets_id};var l=o.getData().panelstore;l.setData([f.data]);o.setData(f.data);o.notify();b.fireEvent("cleardirty");var g=o.getData().threadstore;Ext.apply(g.getProxy().extraParams,d);g.load();c.setActiveItem(1)}});Ext.define("ADDO.ticketadmin.TicketAdminGrid",{extend:"Ext.grid.Panel",xtype:"ticketadmingrid",cls:"ticket-grid-cls",requires:["ADDO.ticketadmin.TicketAdminGridModel","ADDO.ticketadmin.TicketAdminGridController","ADDO.newticket.NewTicketWindow"],controller:"ticketadmingrid",viewModel:{type:"ticketadmingrid"},bind:{store:"{TicketAdminStore}"},dockedItems:[{xtype:"toolbar",cls:"ticket-toolbar-cls",dock:"top",items:[{xtype:"tbfill"},{xtype:"button",cls:"ticket-btn",iconAlign:"right",margin:"10px 0px 0px 0px",text:"New Ticket",handler:"onTicketClick"}]}],columns:[{xtype:"templatecolumn",text:"Subject",tpl:'<a class="ticketLink">{subject}</a>',flex:1.5},{text:"Category",dataIndex:"ticket_category_name",flex:0.5},{text:"Priority",dataIndex:"ticket_priority_name",flex:0.5},{text:"Status",dataIndex:"ticket_status_name",flex:0.5},{xtype:"datecolumn",format:"d-m-Y",text:"Created Date",dataIndex:"created",flex:0.5}],listeners:{rowdblclick:"onCellClick"}});Ext.define("ADDO.ticketadmin.TicketAdminPanel",{extend:"Ext.panel.Panel",xtype:"ticketadminpanel",requires:["ADDO.ticketadmin.TicketAdminGrid","ADDO.thread.TicketsThreadView"],layout:"card",items:[{xtype:"ticketadmingrid"},{xtype:"ticketsthreadview"}]});