Ext.define("Redeem.category.CategoryGrid",{extend:"Ext.grid.Panel",alias:"widget.categorygrid",requires:["Ext.grid.column.Check"],width:"100%",scrollable:"y",header:false,rowLines:false,hideHeaders:true,columnLines:false,columns:[{xtype:"checkcolumn",dataIndex:"selected",align:"right",flex:0.07,listeners:{checkchange:"onSelectionChange"}},{xtype:"gridcolumn",dataIndex:"name",flex:0.93}],listeners:{afterrender:"onCategoryGridRender"}});Ext.define("Redeem.category.CategoryView",{extend:"Ext.container.Container",alias:"widget.categoryview",requires:["Redeem.category.CategoryGrid"],layout:{type:"vbox"},cls:"redeem-category-view",items:[{xtype:"displayfield",value:"Category",cls:"redeem-category-field",height:36,margin:"0 0 0 15"},{xtype:"categorygrid",reference:"categorygrid",cls:"category-grid",bind:{store:"{categorystore}"}}]});Ext.define("Redeem.order.attribute.AttributeGrid",{extend:"Ext.grid.Panel",alias:"widget.attributegrid",cls:"karmalist-cls",plugins:"gridfilters",viewConfig:{loadMask:false},height:500,width:"100%",margin:"0 0 0 10",columns:[{text:"Name",dataIndex:"name",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Code",dataIndex:"code",flex:0.4},{xtype:"actioncolumn",width:50,align:"center",items:[{iconCls:"delete-plus",tooltip:"Delete",handler:function(b,f,a){var c=b.getStore(),e=c.getAt(f),d;d={ddo_productattribute_id:e.data.ddo_productattribute_id};Ext.Ajax.request({url:"/productattribute",method:"DELETE",params:d,success:function(h,g){c.removeAt(f);c.reload();Ext.getBody().unmask()},failure:function(o,g){var m=Ext.decode(o.responseText),l=m.data,h,n;if(l&&l.detail){h=l.detail.split("=");n=h[1].replace(/\(/g,"").replace(/\)/g,"");var k=n.match("still referenced");if(k){Ext.Msg.alert("Failed","Already this attribute is mapped to products")}else{Ext.Msg.alert("Failed",n)}}Ext.getBody().unmask()}})}}]}],listeners:{rowdblclick:"onGridRowClick"}});Ext.define("Redeem.order.attribute.AttributeToolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.attributetoolbar",items:[{xtype:"tbfill"},{xtype:"button",text:"Add New",iconCls:"rule-plus",margin:0,cls:"rule-add-btn",listeners:{click:"onAddNewClick"}}]});Ext.define("Redeem.order.attribute.AttributeViewController",{extend:"Ext.app.ViewController",alias:"controller.attributeviewcontroller",onAddNewClick:function(c,f,b){var a=Ext.ComponentQuery.query("attributewindow")[0]||Ext.create("Redeem.order.attribute.AttributeWindow"),d=a.down("form");this.onFormLoadTrue(d);d.reset();a.down("[name=savebtn]").disable();a.show();a.edit=false},onGridRowClick:function(h,b,f,k,g,c){var a=Ext.ComponentQuery.query("attributewindow")[0]||Ext.create("Redeem.order.attribute.AttributeWindow"),d=a.down("form");this.onFormLoadDirtyFalse(d,b);d.reset();d.loadRecord(b);a.edit=true;a.show();Ext.defer(function(){a.down("[name=savebtn]").disable()},200)},onFormLoadDirtyFalse:function(b,a){b.items.items.forEach(function(c){c.originalValue=a.get(c.name)})},onFormLoadTrue:function(d){var f=d.getValues();var b=d.getForm().getFields().items,c=0,a=b.length;for(;c<a;c++){var e=b[c];e.value="";if(e.mixins&&e.mixins.field&&typeof e.mixins.field.initValue=="function"){e.mixins.field.initValue.apply(e);e.wasDirty=false}}}});Ext.define("Redeem.order.attribute.AttributeViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.attributeviewmodel"});Ext.define("Redeem.order.attribute.AttributeWindowController",{extend:"Ext.app.ViewController",alias:"controller.attributewindowcontroller",onWindowOutsideTap:function(b,c){var a=this;Utility.onSetUpWinOutterTap(b,c,a)},onFormCancelClick:function(c,f,b){var a,d;a=c.up("window");d=a.down("form");d.reset();a.close()},onFormSaveClick:function(c,h,k){var d,m,b,g,f,a,l;d=Ext.getStore("Redeem.store.AttributeStore");m=c.up("window");b=m.down("form");g=b.getValues();a=Ext.String.trim(g.name);l=d.findRecord("name",a,0,false,false,true);if(m.edit){editRec=d.findRecord("ddo_productattribute_id",g.ddo_productattribute_id);if(l&&editRec&&editRec.get("name").toLowerCase()==l.get("name").toLowerCase()){l=null}}if(!l){if(b.isDirty()){if(m.edit){b.updateRecord();d.sync({callback:function(){d.clearFilter(true);d.load()}})}else{d.add(b.getValues());d.sync({callback:function(){d.clearFilter(true);d.load()}})}b.reset();m.close()}else{d.clearFilter(true);d.load();Utility.topAlertMessage("WARNING","Record Already Exists!!")}}else{Ext.Msg.alert("Warning","Current attribute Already added. Please select other one");d.clearFilter(true);d.load()}},onEmployeeClick:function(b){var a=b.up("window");if(a.edit){a.down("[name=savebtn]").enable()}},onCodeChange:function(b){var a=b.up("window");if(a.edit){a.down("[name=savebtn]").enable()}}});Ext.define("Redeem.order.attribute.AttributeWindowViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.attributewindowviewmodel"});Ext.define("Redeem.order.attribute.AttributeWindow",{extend:"Ext.window.Window",requires:["Redeem.order.attribute.AttributeWindowController","Redeem.order.attribute.AttributeWindowViewModel"],alias:"widget.attributewindow",title:"Attribute",controller:"attributewindowcontroller",viewModel:{type:"attributewindowviewmodel"},initComponent:function(){this.callParent(arguments);var b=Ext.getStore("Redeem.store.AttributeJsonStore");if(b&&!b.isLoaded()){b.load()}var a=this.getController();Ext.getDoc().on("click",Ext.bind(a.onWindowOutsideTap,a))},destroy:function(){var a=this.getController();Ext.getDoc().un("click",Ext.bind(a.onWindowOutsideTap,a))},listeners:{show:function(b,a){b.center()}},cls:"attributevalue-win-cls",modal:true,width:600,height:280,closable:false,items:[{xtype:"form",bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save",name:"savebtn",cls:"karmaform-save-btn",listeners:{click:"onFormSaveClick"}}]},height:230,items:[{xtype:"hiddenfield",name:"ddo_productattribute_id"},{xtype:"combobox",name:"name",allowBlank:false,reference:"selectEmployee",displayField:"name",valueField:"value",typeAhead:true,forceSelection:true,minChars:1,emptyText:"Attribute",cls:"rule-name-cls",queryMode:"local",lastQuery:"",store:"Redeem.store.AttributeJsonStore",listeners:{change:"onEmployeeClick"}},{xtype:"textfield",name:"code",emptyText:"Code",allowBlank:false,cls:"rule-name-cls",listeners:{change:"onCodeChange"}}]}]});Ext.define("Redeem.order.attribute.Attribute",{extend:"Ext.container.Container",alias:"widget.attribute",requires:["Redeem.order.attribute.AttributeGrid","Redeem.order.attribute.AttributeToolbar","Redeem.order.attribute.AttributeViewController","Redeem.order.attribute.AttributeViewModel","Redeem.order.attribute.AttributeWindow"],scrollable:false,controller:"attributeviewcontroller",viewModel:{type:"attributeviewmodel"},initComponent:function(){this.callParent(arguments);var a=Ext.getStore("Redeem.store.AttributeStore");if(!a.isLoaded()){Utility.onStoreLoading(a)}},items:[{xtype:"attributetoolbar",cls:"wallet-toolbar-cls",width:"100%",height:70,html:"<h3>Attribute</h3>"},{xtype:"attributegrid",store:"Redeem.store.AttributeStore"}]});Ext.define("Redeem.order.attributevalue.AttributeValueGrid",{extend:"Ext.grid.Panel",alias:"widget.attributevaluegrid",cls:"karmalist-cls",plugins:"gridfilters",height:500,margin:"0 0 0 10",viewConfig:{loadMask:false},columns:[{text:"Attribute",dataIndex:"productattribute",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Attribute Value",dataIndex:"productattributevalue",flex:0.4},{text:"Code",dataIndex:"code",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{xtype:"actioncolumn",width:50,align:"center",items:[{iconCls:"delete-plus",tooltip:"Delete",handler:function(b,f,a){var c=b.getStore(),e=c.getAt(f),d;d={ddo_productattributevalue_id:e.data.ddo_productattribute_value_id};Ext.Ajax.request({url:"/productattributevalues",method:"DELETE",params:d,success:function(h,g){c.removeAt(f);c.reload();Ext.getBody().unmask()},failure:function(o,g){var m=Ext.decode(o.responseText),l=m.data,h,n;if(l&&l.detail){h=l.detail.split("=");n=h[1].replace(/\(/g,"").replace(/\)/g,"");var k=n.match("still referenced");if(k){Ext.Msg.alert("Failed","Already this attribute values is mapped to products")}else{Ext.Msg.alert("Failed",n)}}Ext.getBody().unmask()}})}}]}],listeners:{rowdblclick:"onGridRowClick"}});Ext.define("Redeem.order.attributevalue.AttributeValueToolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.attributevaluetoolbar",items:[{xtype:"tbfill"},{xtype:"button",text:"Add New",iconCls:"rule-plus",margin:0,cls:"rule-add-btn",listeners:{click:"onAddNewClick"}}]});Ext.define("Redeem.order.attributevalue.AttributeValueViewController",{extend:"Ext.app.ViewController",alias:"controller.attributevalueviewcontroller",onAddNewClick:function(c,f,b){var a=Ext.ComponentQuery.query("attributevaluewindow")[0]||Ext.create("Redeem.order.attributevalue.AttributeValueWindow"),d=a.down("form");this.onFormLoadTrue(d);d.reset();a.show();a.edit=false},onGridRowClick:function(h,b,f,k,g,c){var a=Ext.ComponentQuery.query("attributevaluewindow")[0]||Ext.create("Redeem.order.attributevalue.AttributeValueWindow"),d=a.down("form");this.onFormLoadDirtyFalse(d,b);d.reset();d.loadRecord(b);a.show();a.edit=true},onFormLoadDirtyFalse:function(b,a){b.items.items.forEach(function(c){c.originalValue=a.get(c.name)})},onFormLoadTrue:function(d){var f=d.getValues();var b=d.getForm().getFields().items,c=0,a=b.length;for(;c<a;c++){var e=b[c];e.value="";if(e.mixins&&e.mixins.field&&typeof e.mixins.field.initValue=="function"){e.mixins.field.initValue.apply(e);e.wasDirty=false}}}});Ext.define("Redeem.order.attributevalue.AttributeValueViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.attributevalueviewmodel"});Ext.define("Redeem.order.attributevalue.AttributeValueWindowController",{extend:"Ext.app.ViewController",alias:"controller.attributevaluewindowcontroller",onWindowOutsideTap:function(b,c){var a=this;Utility.onSetUpWinOutterTap(b,c,a)},onFormCancelClick:function(c,f,b){var a,d;a=c.up("window");d=a.down("form");d.reset();a.close()},onFormSaveClick:function(c,l,m){var f,d,b,k,g,a,n=false,o=false,h=false;f=Ext.getStore("Redeem.store.AttributeValueStore");d=c.up("window");b=d.down("form");k=b.getValues();k.productattributevalue=Ext.String.trim(k.productattributevalue);k.code=Ext.String.trim(k.code);a=k.name;if(!d.edit){f.each(function(e){if(((e.data.ddo_productattribute_id==k.ddo_productattribute_id)&&(e.data.productattributevalue.toLowerCase()==k.productattributevalue.toLowerCase()))||(e.data.code.toLowerCase()==k.code.toLowerCase())){n=true}if(e.data.productattributevalue.toLowerCase()==k.productattributevalue.toLowerCase()){o=true}else{if(e.data.code.toLowerCase()==k.code.toLowerCase()){h=true}}})}else{f.each(function(e){if((e.data.ddo_productattribute_value_id!=k.ddo_productattribute_value_id)&&(((e.data.ddo_productattribute_id==k.ddo_productattribute_id)&&(e.data.productattributevalue.toLowerCase()==k.productattributevalue.toLowerCase()))||(e.data.code.toLowerCase()==k.code.toLowerCase()))){n=true}if((e.data.ddo_productattribute_value_id!=k.ddo_productattribute_value_id)&&(e.data.productattributevalue.toLowerCase()==k.productattributevalue.toLowerCase())){o=true}else{if((e.data.ddo_productattribute_id==k.ddo_productattribute_id)&&(e.data.code.toLowerCase()==k.code.toLowerCase())){h=true}}})}if(!n){if(b.isDirty()){if(d.edit){b.updateRecord();f.sync({callback:function(){f.load()}})}else{f.add(b.getValues());f.sync({callback:function(){f.load()}})}b.reset();d.close()}else{Utility.topAlertMessage("WARNING","Record Already Exists!!")}}else{if(o){Ext.Msg.alert("Warning","Current attribute value Already added. Please select other one")}else{if(h){Ext.Msg.alert("Warning","Current attribute code Already added. Please select other one")}}}}});Ext.define("Redeem.order.attributevalue.AttributeValueWindowViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.attributevaluewindowviewmodel"});Ext.define("Redeem.order.attributevalue.AttributeValueWindow",{extend:"Ext.window.Window",requires:["Redeem.order.attributevalue.AttributeValueWindowController","Redeem.order.attributevalue.AttributeValueWindowViewModel"],alias:"widget.attributevaluewindow",title:"Attribute Value",controller:"attributevaluewindowcontroller",viewModel:{type:"attributevaluewindowviewmodel"},initComponent:function(){this.callParent(arguments);var b=Ext.getStore("Redeem.store.AttributeStore");if(b&&!b.isLoaded()){b.load()}var a=this.getController();Ext.getDoc().on("click",Ext.bind(a.onWindowOutsideTap,a))},destroy:function(){var a=this.getController();Ext.getDoc().un("click",Ext.bind(a.onWindowOutsideTap,a))},listeners:{show:function(b,a){b.center()}},closable:false,cls:"attributevalue-win-cls",modal:true,width:600,height:280,items:[{xtype:"form",bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save",cls:"karmaform-save-btn",formBind:true,listeners:{click:"onFormSaveClick"}}]},height:250,items:[{xtype:"hiddenfield",name:"ddo_productattribute_value_id"},{xtype:"combobox",allowBlank:false,name:"ddo_productattribute_id",reference:"selectEmployee",displayField:"name",valueField:"ddo_productattribute_id",typeAhead:true,forceSelection:true,minChars:1,emptyText:"Attribute",cls:"rule-name-cls",queryMode:"local",lastQuery:"",store:"Redeem.store.AttributeStore"},{xtype:"textfield",allowBlank:false,name:"productattributevalue",emptyText:"Attribute Value",required:true,cls:"rule-name-cls"},{xtype:"textfield",name:"code",allowBlank:false,emptyText:"Code",cls:"rule-name-cls"}]}]});Ext.define("Redeem.order.attributevalue.AttributeValue",{extend:"Ext.container.Container",alias:"widget.attributevalue",requires:["Redeem.order.attributevalue.AttributeValueGrid","Redeem.order.attributevalue.AttributeValueToolbar","Redeem.order.attributevalue.AttributeValueViewController","Redeem.order.attributevalue.AttributeValueViewModel","Redeem.order.attributevalue.AttributeValueWindow"],scrollable:false,controller:"attributevalueviewcontroller",viewModel:{type:"attributevalueviewmodel"},initComponent:function(){this.callParent(arguments);var a=Ext.getStore("Redeem.store.AttributeValueStore");if(!a.isLoaded()){Utility.onStoreLoading(a)}},items:[{xtype:"attributevaluetoolbar",cls:"wallet-toolbar-cls",width:"100%",height:70,html:"<h3>Attribute Value</h3>"},{xtype:"attributevaluegrid",store:"Redeem.store.AttributeValueStore"}]});Ext.define("Redeem.order.category.CategoryValueGrid",{extend:"Ext.grid.Panel",alias:"widget.categoryvaluegrid",cls:"karmalist-cls",plugins:"gridfilters",height:500,viewConfig:{loadMask:false},margin:"0 0 0 10",columns:[{text:"Name",dataIndex:"productcategoryname",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Code",dataIndex:"code",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{xtype:"actioncolumn",width:50,align:"center",items:[{iconCls:"delete-plus",tooltip:"Delete",handler:function(b,f,a){var c=b.getStore(),e=c.getAt(f),d;d={categoryId:e.data.ddo_productcategory_id};Ext.Ajax.request({url:"/productcategory",method:"DELETE",params:d,success:function(h,g){c.removeAt(f);c.reload();Ext.getBody().unmask()},failure:function(o,g){var m=Ext.decode(o.responseText),l=m.data,h,n;if(l&&l.detail){h=l.detail.split("=");n=h[1].replace(/\(/g,"").replace(/\)/g,"");var k=n.match("still referenced");if(k){Ext.Msg.alert("Failed","Already this category is mapped to products")}else{Ext.Msg.alert("Failed",n)}}Ext.getBody().unmask()}})}}]}],listeners:{rowdblclick:"onGridRowClick"}});Ext.define("Redeem.order.category.CategoryValueToolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.categoryvaluetoolbar",items:[{xtype:"tbfill"},{xtype:"button",text:"Add New",iconCls:"rule-plus",margin:0,cls:"rule-add-btn",listeners:{click:"onAddNewClick"}}]});Ext.define("Redeem.order.category.CategoryValueViewController",{extend:"Ext.app.ViewController",alias:"controller.categoryvalueviewcontroller",onAddNewClick:function(c,f,b){var a=Ext.ComponentQuery.query("categoryvaluewindow")[0]||Ext.create("Redeem.order.category.CategoryValueWindow"),d=a.down("form");this.onFormLoadTrue(d);d.reset();a.show();a.edit=false},onGridRowClick:function(h,b,f,k,g,c){var a=Ext.ComponentQuery.query("categoryvaluewindow")[0]||Ext.create("Redeem.order.category.CategoryValueWindow"),d=a.down("form");this.onFormLoadDirtyFalse(d,b);d.reset();d.loadRecord(b);a.show();a.edit=true},onFormLoadDirtyFalse:function(b,a){b.items.items.forEach(function(c){c.originalValue=a.get(c.name)})},onFormLoadTrue:function(d){var f=d.getValues();var b=d.getForm().getFields().items,c=0,a=b.length;for(;c<a;c++){var e=b[c];e.value="";if(e.mixins&&e.mixins.field&&typeof e.mixins.field.initValue=="function"){e.mixins.field.initValue.apply(e);e.wasDirty=false}}}});Ext.define("Redeem.order.category.CategoryValueViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.categoryvalueviewmodel"});Ext.define("Redeem.order.category.CategoryValueWindowController",{extend:"Ext.app.ViewController",alias:"controller.categoryvaluewindowcontroller",onWindowOutsideTap:function(b,c){var a=this;Utility.onSetUpWinOutterTap(b,c,a)},onFormCancelClick:function(b,f,a){var d,c;d=b.up("window");c=d.down("form");c.reset();d.close()},onFormSaveClick:function(c,k,l){var f,d,b,h,g,a,m;f=Ext.getStore("Redeem.store.CategoryValueStore");d=c.up("window");b=d.down("form");h=b.getValues();a=Ext.String.trim(h.productcategoryname);m=f.findRecord("productcategoryname",a,0,false,false,true);if(d.edit){editRec=f.findRecord("ddo_productcategory_id",h.ddo_productcategory_id);if(m&&editRec&&editRec.get("productcategoryname").toLowerCase()==m.get("productcategoryname").toLowerCase()){m=null}}if(!m){if(b.isDirty()){if(d.edit){b.updateRecord();f.sync({callback:function(){f.clearFilter(true);f.load()}})}else{f.add(b.getValues());f.sync({callback:function(){f.clearFilter(true);f.load()}})}b.reset();d.close()}else{Utility.topAlertMessage("WARNING","Record Already Exists!!");f.clearFilter(true);f.load()}}else{Ext.Msg.alert("Warning","Current Category value Already added. Please select other one");f.clearFilter(true);f.load()}}});Ext.define("Redeem.order.category.CategoryValueWindowViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.categoryvaluewindowviewmodel"});Ext.define("Redeem.order.category.CategoryValueWindow",{extend:"Ext.window.Window",requires:["Redeem.order.category.CategoryValueWindowController","Redeem.order.category.CategoryValueWindowViewModel"],alias:"widget.categoryvaluewindow",title:"Category",controller:"categoryvaluewindowcontroller",viewModel:{type:"categoryvaluewindowviewmodel"},initComponent:function(){this.callParent(arguments);var a=this.getController();Ext.getDoc().on("click",Ext.bind(a.onWindowOutsideTap,a))},destroy:function(){var a=this.getController();Ext.getDoc().un("click",Ext.bind(a.onWindowOutsideTap,a))},listeners:{show:function(b,a){b.center()}},closable:false,cls:"attributevalue-win-cls",modal:true,width:600,height:280,items:[{xtype:"form",bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save",cls:"karmaform-save-btn",formBind:true,listeners:{click:"onFormSaveClick"}}]},height:230,items:[{xtype:"hiddenfield",name:"ddo_productcategory_id"},{xtype:"textfield",allowBlank:false,name:"productcategoryname",emptyText:" Category Name",required:true,cls:"rule-name-cls"},{xtype:"textfield",name:"code",maxLength:10,enforceMaxLength:true,emptyText:"Code",cls:"rule-name-cls"}]}]});Ext.define("Redeem.order.category.CategoryValue",{extend:"Ext.container.Container",alias:"widget.categoryvalue",requires:["Redeem.order.category.CategoryValueGrid","Redeem.order.category.CategoryValueToolbar","Redeem.order.category.CategoryValueViewController","Redeem.order.category.CategoryValueViewModel","Redeem.order.category.CategoryValueWindow"],scrollable:false,controller:"categoryvalueviewcontroller",viewModel:{type:"categoryvalueviewmodel"},initComponent:function(){this.callParent(arguments);var a=Ext.getStore("Redeem.store.CategoryValueStore");if(!a.isLoaded()){Utility.onStoreLoading(a)}},items:[{xtype:"categoryvaluetoolbar",cls:"wallet-toolbar-cls",width:"100%",height:70,html:"<h3>Category</h3>"},{xtype:"categoryvaluegrid",store:"Redeem.store.CategoryValueStore"}]});Ext.define("Redeem.order.product.ProductValueGrid",{extend:"Ext.grid.Panel",alias:"widget.productvaluegrid",cls:"karmalist-cls",plugins:"gridfilters",height:500,reference:"productvaluegrid",viewConfig:{loadMask:false},margin:"0 0 0 10",columns:[{text:"Name",dataIndex:"productname",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Category",dataIndex:"categoryname",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Price",dataIndex:"price",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Quantity",dataIndex:"quantity",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{text:"Code",dataIndex:"code",flex:0.3,height:42,filter:{type:"string",itemDefaults:{emptyText:"Search..."}}},{xtype:"actioncolumn",width:50,align:"center",items:[{iconCls:"delete-plus",tooltip:"Delete",handler:function(b,f,a){var c=b.getStore(),e=c.getAt(f),d;d={ddo_product_id:e.data.ddo_product_id};Ext.Ajax.request({url:"/product",method:"DELETE",params:d,success:function(h,g){c.removeAt(f);c.reload();Ext.getBody().unmask()},failure:function(l,g){var k=Ext.decode(l.responseText),h=k.message;Ext.Msg.alert("Failed",h);Ext.getBody().unmask()}})}}]}],listeners:{rowdblclick:"onGridRowClick"}});Ext.define("Redeem.order.product.ProductValueToolbar",{extend:"Ext.toolbar.Toolbar",alias:"widget.productvaluetoolbar",items:[{xtype:"tbfill"},{xtype:"button",text:"Add New",iconCls:"rule-plus",margin:0,cls:"rule-add-btn",listeners:{click:"onAddNewClick"}}]});Ext.define("Redeem.order.product.ProductValueViewController",{extend:"Ext.app.ViewController",alias:"controller.productvalueviewcontroller",onAddNewClick:function(d,h,c){var g=Ext.ComponentQuery.query("setattributewindow")[0]||Ext.create("Redeem.order.product.SetAttributeWindow"),f=g.down("form"),b=g.getViewModel(),a=g.down("tabpanel");a.setActiveTab(0);this.onFormLoadTrue(f);f.reset();b.set("product_id","");g.show();g.edit=false},onGridRowClick:function(o,f,k,l,g,h){var n=Ext.ComponentQuery.query("setattributewindow")[0]||Ext.create("Redeem.order.product.SetAttributeWindow"),a=n.down("form"),m=n.getViewModel(),d,c=Ext.getStore("Redeem.store.SetAttributeStore"),b=Ext.getStore("Redeem.store.ProductImagesStore");tabpanel=n.down("tabpanel");tabpanel.setActiveTab(0);this.onFormLoadDirtyFalse(a,f);a.reset();a.loadRecord(f);m.set("product_id",f.data.ddo_product_id);m.set("product_name",f.data.productname);d={ddo_product_id:f.data.ddo_product_id};Ext.apply(c.getProxy().extraParams,d);Ext.apply(b.getProxy().extraParams,d);c.load();b.load();n.show();n.edit=true},onFormLoadDirtyFalse:function(b,a){b.items.items.forEach(function(c){c.originalValue=a.get(c.name)})},onFormLoadTrue:function(d){var f=d.getValues();var b=d.getForm().getFields().items,c=0,a=b.length;for(;c<a;c++){var e=b[c];e.value="";if(e.mixins&&e.mixins.field&&typeof e.mixins.field.initValue=="function"){e.mixins.field.initValue.apply(e);e.wasDirty=false}}},onRowClick:function(b,a,f,h,g,d){var c=this.getViewModel();c.set("setAttributeBtn",false)}});Ext.define("Redeem.order.product.ProductValueViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.productvalueviewmodel",data:{setAttributeBtn:true}});Ext.define("Redeem.order.product.SetAttributeWindowController",{extend:"Ext.app.ViewController",alias:"controller.setattributewindowcontroller",onWindowOutsideTap:function(b,c){if(Utility.nominatAlert){var a=this;Utility.onSetUpWinOutterTap(b,c,a)}},onFormCancelClick:function(b,f,a){var d,c;d=b.up("window");c=d.down("form");c.reset();d.close()},onFormSaveClick:function(k,s,b){var n,l,c,f,t,d,r,v,g,u,a;l=k.up("window");c=l.down("form"),u=l.getViewModel();d=l.down("tabpanel");a=d.getActiveTab(),r=l.down("setproductimagestab");f=c.getValues();var m=[],q=[];var n=l.down("grid").getStore();var h=Ext.getStore("Redeem.store.ProductValueStore");var p=l.down("setproductimages");var o=p.getStore();if(a.xtype=="setproductimagestab"){o.sync({success:function(e,w){n.load();d.setActiveItem(r);l.close();h.load()}})}else{n.sync({success:function(e,w){n.load();d.setActiveItem(r);h.load()}})}},onAttributeComboSelect:function(f,b,d){var g=this.getReferences(),e,c,a;e=g.attributevalueref;c=e.getStore();a=f.getValue();c.clearFilter(true);c.filterBy(function(h){if(h.data.ddo_productattribute_id==a){return true}});if(c.getCount()==0){e.setReadOnly(true)}else{e.setReadOnly(false)}},onAddItemClick:function(k,s,b){var d=k.up("window").getViewModel();var n=d.get("product_id");var c=k.up("form"),r=this.getReferences(),l=Ext.getStore("Redeem.store.SetAttributeStore"),g=Ext.getStore("Redeem.store.AttributeValueStore"),p=r.attributeref,o=r.attributevalueref,h=c.getValues(),t=false;var u="";var f="";var q="";c.items.items.forEach(function(v){if(v.value){if(v.xtype=="combobox"){var e=g.findRecord("ddo_productattribute_value_id",v.value);u=u+"-"+e.data.code;q=q+","+e.data.ddo_productattribute_value_id;f=f+","+e.data.ddo_productattribute_id}}},this);var a=u.substring(1);var m=a.split("-");l.each(function(w){var v=w.data.attribute_code.split("-");var e=Ext.Array.difference(v,m);if(e.length==0){t=true}});if(t){Ext.Msg.alert("Alert","already attribute added")}else{l.add({ddo_product_id:n,attribute_code:u.substring(1),attribute_ids:f.substring(1),attribute_value_ids:q.substring(1),quantity:h.quantity})}c.reset()},onImgUpload:function(k,o,g){var l=this,b=k.fileInputEl.dom.files[0],d=k.value,e=new FileReader(),n=b.type,m=k.up("setproductimagestab").down("setproductimages"),h=m.getStore(),c=k.up("window").getViewModel().get("product_id"),f=false,a=h.getCount();if(a<=4){e.onload=function(){if(n=="image/png"||n=="image/jpg"||n=="image/jpeg"){k.up("form").submit({url:"/feed/feedsPostedPics",success:function(){var q=Ext.JSON.decode(arguments[1].response.responseText),p=q.data;if(h.getCount()==0){f=true}h.add({imagepath:p,isdefault:f,ddo_product_id:c});if(f){m.getSelectionModel().select(0)}},failure:function(){Ext.toast({html:"Image not added",width:150,align:"t"})}})}else{Ext.toast({html:"Invalid Format",width:150,align:"t"})}};e.readAsDataURL(b)}else{Utility.topAlertMessage("Alert","You can't add more than 5 images")}},productSetupItemClick:function(b,c,m,e,k,f){var g=this,d=k.getTarget(),l=Ext.get(d),h=b.getStore();if(l.hasCls("ddo-product-icon-delete")){h.remove(c)}else{if(c){b.getSelectionModel().select(c)}var a=h.findRecord("isdefault",true);if(a){a.set("isdefault",false)}c.set("isdefault",true)}},SetProductImagesRender:function(a){var b=a.getStore();a.getSelectionModel().select(b.findRecord("isdefault",true))},onBeforeTabChange:function(g,a,e,d){var c=this.getViewModel().get("product_id");if(Ext.isEmpty(c)){Utility.topAlertMessage("Alert","please add and save product first");return false}if(a.xtype=="setproductimagestab"){var b=a.down("dataview"),f=a.down("dataview").getStore();record=f.findRecord("isdefault",true);if(record){b.getSelectionModel().select(record)}}},onSetAttributesGridRowClick:function(f,a,c,g,d,b){}});Ext.define("Redeem.order.product.SetAttributeWindowViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.setattributewindowviewmodel",data:{product_id:"",product_name:""}});Ext.define("Redeem.order.product.SetAttributesTab",{extend:"Ext.panel.Panel",alias:"widget.setattributes",title:"Attributes",initComponent:function(){this.callParent(arguments);var a=Ext.getStore("Redeem.store.AttributeStore"),b=Ext.getStore("Redeem.store.AttributeValueStore");if(a&&!a.isLoaded()){a.load();b.load()}},bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save and Continue",cls:"karmaform-save-btn",formBind:true,listeners:{click:"onFormSaveClick"}}]},items:[{xtype:"form",layout:"column",width:600},{xtype:"grid",bind:{title:"{product_name} Attributes"},maxHeight:200,margin:5,columnLines:true,rowLines:false,store:"Redeem.store.SetAttributeStore",cls:"redeemhistoryitems-grid-view",columns:[{text:"Attribute Code",dataIndex:"attribute_code",flex:1},{text:"Qty",dataIndex:"quantity",flex:0.5},{xtype:"actioncolumn",align:"center",items:[{iconCls:"delete-plus",tooltip:"Delete",handler:function(b,e,a){var c=b.getStore(),d=c.getAt(e);c.remove(d)}}]}],listeners:{rowdblclick:"onSetAttributesGridRowClick",afterrender:function(b,c,a){var d=Ext.getStore("Redeem.store.AttributeValueStore");Utility.addAttributes(d)}}}]});Ext.define("Redeem.order.product.SetProductImages",{extend:"Ext.view.View",alias:"widget.setproductimages",loadMask:false,selectedItemCls:"imgselected-cls",selectionModel:{mode:"SINGLE",allowDeslect:true},store:"Redeem.store.ProductImagesStore",emptyText:'<div class = "ddo-product-emptytext">No Images Added</div>',tpl:['<tpl for=".">','<div class="product-main-cls" {[this.validEllipsesQtip(values.iddefault)]}>','<span class="product-nonselec-cls"></span>','<div class = "ddo-product-uploadicon">','<img src="{imagepath}" class="ddo-product-icon" wrap-td="image_url">',"</div>",'<div class="ddo-product-icon-delete" data-action="deleteIcon"></div>',"</div>","</tpl>",{validEllipsesQtip:function(a){var c="Default product image";var b=" data-qtip= '"+c+"'";return(a)?b:""}}],itemSelector:"div.product-main-cls",listeners:{itemclick:"productSetupItemClick"}});Ext.define("Redeem.order.product.SetProductImagesTab",{extend:"Ext.panel.Panel",alias:"widget.setproductimagestab",title:"Images",requires:["Redeem.order.product.SetProductImages"],layout:{type:"hbox"},bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save",cls:"karmaform-save-btn",formBind:true,listeners:{click:"onFormSaveClick"}}]},items:[{xtype:"setproductimages"},{xtype:"form",cls:"karmasetup-feed-form",items:[{xtype:"filefield",opType:"upload",name:"feedsImage",reference:"karmaUploadIcon",itemId:"karmaUploadIcon",accept:"image",buttonOnly:true,buttonConfig:{iconCls:"plus-upload-icon-cls",cls:"upload-button-cls",width:65,height:65,margin:"40 0 0 12"},width:80,buttonText:"",listeners:{change:"onImgUpload"}}]}]});Ext.define("Redeem.order.product.ProductValueFormController",{extend:"Ext.app.ViewController",alias:"controller.productvalueformcontroller",onFormCancelClick:function(b,f,a){var d,c;d=b.up("window");c=d.down("form");c.reset();d.close()},onFormSaveClick:function(c,m,n){var f,s,b,k,h,a,o,r,p,q,g,d,l;f=Ext.getStore("Redeem.store.ProductValueStore");s=c.up("window");r=s.down("tabpanel");p=s.down("setattributes");g=Ext.getStore("Redeem.store.SetAttributeStore");d=Ext.getStore("Redeem.store.ProductImagesStore");b=s.down("form");k=b.getValues();q=s.getViewModel();a=Ext.String.trim(k.productname);o=f.findRecord("productname",a,0,false,false,true);if(s.edit){editRec=f.findRecord("ddo_product_id",k.ddo_product_id);if(o&&editRec&&editRec.get("productname").toLowerCase()==o.get("productname").toLowerCase()&&editRec.get("ddo_productcategory_id")==o.get("ddo_productcategory_id")){o=null}}if(!o){if(b.isDirty()){if(s.edit){b.updateRecord();f.sync({callback:function(){f.clearFilter(true);f.load();r.setActiveItem(p)}})}else{f.add(b.getValues());f.sync({success:function(e){if(e.operations[0].getResponse()){var u=e.operations[0].getResponse().responseText,t=Ext.decode(u).product_id;q.set("product_id",t);q.set("product_name",k.productname);l={ddo_product_id:t};Ext.apply(g.getProxy().extraParams,l);Ext.apply(d.getProxy().extraParams,l);g.load();d.load()}f.clearFilter(true);r.setActiveItem(p);f.load()},failure:function(v){var u=v.operations[0].getError(),t=v.operations[0].error.response,z;if(Ext.isObject(u)){if(u.status&&u.statusText){var y=Ext.decode(t.responseText),w=y.data,e,z;if(w){e=w.detail.split("=");z=e[1].replace(/\(/g,"").replace(/\)/g,"");Ext.Msg.alert("Failed",z)}}}f.load();b.reset()}})}}else{f.clearFilter(true);f.load();Utility.topAlertMessage("WARNING","Record Already Exists!!")}}else{f.clearFilter(true);f.load();Ext.Msg.alert("Warning","Current Product value Already added. Please select other one")}}});Ext.define("Redeem.order.product.ProductValueFormViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.productvalueformviewmodel"});Ext.define("Redeem.order.product.ProductValueForm",{extend:"Ext.form.Panel",requires:["Redeem.order.product.ProductValueFormController","Redeem.order.product.ProductValueFormViewModel"],alias:"widget.productvalueform",title:"Product",controller:"productvalueformcontroller",viewModel:{type:"productvalueformviewmodel"},initComponent:function(){this.callParent(arguments);var b=Ext.getStore("Redeem.store.CategoryValueStore");if(b&&!b.isLoaded()){b.load()}var a=this.getController()},bbar:{layout:{type:"hbox"},padding:"25 0 20 0",items:[{xtype:"button",text:"Cancel",cls:"karmaform-cancel-btn",listeners:{click:"onFormCancelClick"}},{xtype:"button",text:"Save and Continue",cls:"karmaform-save-btn",formBind:true,listeners:{click:"onFormSaveClick"}}]},items:[{xtype:"hiddenfield",name:"ddo_product_id"},{xtype:"textfield",allowBlank:false,name:"productname",emptyText:"Product Name",required:true,cls:"rule-name-cls"},{xtype:"combobox",name:"ddo_productcategory_id",reference:"selectEmployee",displayField:"productcategoryname",valueField:"ddo_productcategory_id",typeAhead:true,forceSelection:true,minChars:1,emptyText:"Category",cls:"rule-name-cls",queryMode:"local",allowBlank:false,lastQuery:"",store:"Redeem.store.CategoryValueStore"},{xtype:"textfield",maskRe:/[0-9]/,allowBlank:false,name:"price",emptyText:"Price",required:true,cls:"rule-name-cls"},{xtype:"textfield",maskRe:/[0-9]/,allowBlank:false,name:"quantity",emptyText:"Quantity",required:true,cls:"rule-name-cls"},{xtype:"textfield",name:"code",emptyText:"Code",enforceMaxLength:true,maxLength:10,allowBlank:false,cls:"rule-name-cls"}]});Ext.define("Redeem.order.product.SetAttributeWindow",{extend:"Ext.window.Window",requires:["Redeem.order.product.SetAttributeWindowController","Redeem.order.product.SetAttributeWindowViewModel","Redeem.order.product.SetAttributesTab","Redeem.order.product.SetProductImagesTab","Redeem.order.product.ProductValueForm"],header:false,alias:"widget.setattributewindow",controller:"setattributewindowcontroller",viewModel:{type:"setattributewindowviewmodel"},initComponent:function(){this.callParent(arguments);var b=Ext.getStore("Redeem.store.AttributeStore"),c=Ext.getStore("Redeem.store.AttributeValueStore");if(b&&!b.isLoaded()){b.load();c.load()}var a=this.getController();Ext.getDoc().on("click",Ext.bind(a.onWindowOutsideTap,a))},destroy:function(){var a=this.getController();Ext.getDoc().un("click",Ext.bind(a.onWindowOutsideTap,a))},listeners:{show:function(b,a){b.center()}},closable:false,cls:"attributevalue-win-cls",modal:true,width:600,constrain:true,layout:"fit",resizable:false,items:[{xtype:"tabpanel",padding:"20 0 0 0",cls:"wallethistorytab-cls",tabBar:{layout:{pack:"center"},height:70},items:[{xtype:"productvalueform"},{xtype:"setattributes"},{xtype:"setproductimagestab"}],listeners:{beforetabchange:"onBeforeTabChange"}}]});Ext.define("Redeem.order.product.ProductValue",{extend:"Ext.container.Container",alias:"widget.productvalue",requires:["Redeem.order.product.ProductValueGrid","Redeem.order.product.ProductValueToolbar","Redeem.order.product.ProductValueViewController","Redeem.order.product.ProductValueViewModel","Redeem.order.product.SetAttributeWindow"],scrollable:false,controller:"productvalueviewcontroller",viewModel:{type:"productvalueviewmodel"},initComponent:function(){this.callParent(arguments);var b=Ext.getStore("Redeem.store.ProductValueStore");if(!b.isLoaded()){Utility.onStoreLoading(b)}var a=Ext.getStore("Redeem.store.AttributeStore"),c=Ext.getStore("Redeem.store.AttributeValueStore");if(!a.isLoaded()){a.load();c.load()}},items:[{xtype:"productvaluetoolbar",cls:"wallet-toolbar-cls",width:"100%",height:70,html:"<h3>Product</h3>"},{xtype:"productvaluegrid",store:"Redeem.store.ProductValueStore"}]});Ext.define("Redeem.product.Checkout",{extend:"Ext.view.View",alias:"widget.checkout",cls:"redeem-checkout",tpl:['<tpl for=".">','<div class="checkout-wrap">','<div class="div-one">','<img src="{[this.getImage(values)]}" class="checkout-image"/>',"</div>",'<div class="div-two" {[this.validEllipsesQtip(values.name, 16)]}>{[this.getEllipseText(values.name, 16)]}</div>','<div class="div-three">','<span class="exactPointPCls">P</span>','<span class="exactPointsCls">{exactPoints}</span>',"</div>",'<div class="div-four">',"</div>",'<div class="div-five">','<span><input class="txtField"  id="{[this.getIds(values)]}" style="width:50px" type="number" value="{qty}" min="1"/></span>','<span class="x-fa fa-trash-o delete"></span>',"</div>","</div>","</tpl>",{getIds:function(a){return a.id},getEllipseText:function(b,a){if(Ext.isEmpty(b)){b=""}return Ext.String.ellipsis(b,a)},validEllipsesQtip:function(b,a){if(Ext.isEmpty(b)){b=""}var c=" data-qtip='"+b+"'";return(b.length>a)?c:""},getImage:function(a){if(Ext.isEmpty(a.img)){return"resources/images/redeem/comingsoon.jpg"}return a.img}}],itemSelector:"div.checkout-wrap",emptyText:"No products available",listeners:{itemclick:"onCheckoutItemClick",change:{element:"el",delegate:"input.txtField",fn:"onchange"}}});Ext.define("Redeem.product.CheckoutWindowController",{extend:"Ext.app.ViewController",alias:"controller.checkoutwindow",onCheckoutItemClick:function(m,d,o,f,h,k){var a=h.target.classList,b=Ext.first("redeem-view").getViewModel(),l=this.getView(),c=l.down("#valuepoints"),n=l.down("#orignalvalue");if(Ext.Array.contains(a,"delete")){m.getStore().remove(d);if(m.getStore().getCount()===0){Ext.first("#Checkout_button").setDisabled(true);b.set("badgeText"," ");b.set("selectedItems",[]);c.setText("Redeemed "+0);n.setText("Available "+(n.prize+d.get("points")))}else{var g=b.get("selectedItems");g.pop(d.getData());b.set("selectedItems",g);c.prize=(c.prize-d.get("points"));b.set("badgeText",'<div class="btn-badge">'+m.getStore().getCount()+"</div>");c.setText("Redeemed "+c.prize);n.prize=(n.prize+d.get("points"));n.setText("Available "+n.prize)}}else{if(Ext.Array.contains(a,"size")){this.onClickSize(d,h,o.childNodes[1].childNodes[0])}else{if(Ext.Array.contains(a,"color")){this.onClickColor(d,h,o.childNodes[1].childNodes[2])}}}},onClickSize:function(b,h,f){var g=h.getTarget(),k=f.childNodes,a=this.getView().down("checkout"),c=a.getStore(),d;Ext.Array.each(k,function(l,e,m){if(Ext.Array.contains(l.classList,"selected")){l.className="size";return false}});d=g.innerHTML;g.className=g.className+" selected";for(x in b.data.attributeOptions.size){if(b.data.attributeOptions.size[x].dispVal==d){b.data.attributeOptions.size[x].selected=" selected"}else{b.data.attributeOptions.size[x].selected=""}}},onClickColor:function(b,g,d){var f=g.getTarget(),k=d.childNodes,a=this.getView().down("checkout"),c=a.getStore();Ext.Array.each(k,function(l,e,m){if(Ext.Array.contains(l.classList,"selected")){l.className="color";return false}});var h=f.outerHTML;index1=f.outerHTML.indexOf(":")+1;index2=f.outerHTML.indexOf(";");index3=index2-index1;cstr=h.substr(index1,index3);f.className=f.className+" selected";for(x in b.data.attributeOptions.color){if(b.data.attributeOptions.color[x].val==cstr){b.data.attributeOptions.color[x].selected=" selected"}else{b.data.attributeOptions.color[x].selected=""}}},onConfirmBtnClick:function(b,o){var n=this.getView(),m,p,f=[],h,q,a=Ext.create("Ext.window.Toast",{width:300,height:200,closeAction:"hide",html:"Success !",align:"t"});var k="";var e=Ext.getStore("Redeem.store.AttributeStore");var d=Ext.getStore("Redeem.store.AttributeValueStore");n.setLoading(true);if(!Ext.isEmpty(n)){m=n.down("checkout");if(!Ext.isEmpty(m)){p=m.getStore();for(i=0;i<p.getCount();i++){var g=p.getAt(i),l=g.getData();for(j=0;j<l.attributeOptions.color.length;j++){if(l.attributeOptions.color[j].selected===" selected"){h=l.attributeOptions.color[j].val}}for(j=0;j<l.attributeOptions.size.length;j++){if(l.attributeOptions.size[j].selected===" selected"){q=l.attributeOptions.size[j].dispVal}}k=k+l.points;f.push({ddo_product_id:l.pid,PriceEntered:l.points,totalprice:l.points,lineprice:l.points,unitprice:(l.points/l.qty),quantity:l.qty,QtyOrdered:l.qty,Description:"Size: "+q+" ,  color: "+h})}var c=Ext.JSON.encode(f);Ext.Ajax.request({url:"/productredeem",method:"POST",scope:this,params:{productListArr:c,total_order_price:k},success:function(r,t){var u,v,s;u=Ext.decode(r.responseText);console.log("obj: ",u);if(u.success){v=Ext.ComponentQuery.query("redeem-view")[0];s=Ext.getStore("login");a.update("Success !");a.show();Ext.getStore("Redeem.store.ProductValueStore").load();Ext.getStore("redeem.RedeemGridStore").load();v.getViewModel().getStore("productstore").load();v.getViewModel().set("rewardPoints",u.reward_points);s.getAt(0).get("score").rewardpoints=u.reward_points;this.getView().close();v.close()}else{a.update(u.message);a.show()}n.setLoading(false)},failure:function(r,s){n.setLoading(false);console.log("server-side failure with status code "+r.status)}})}}},onchange:function(m,h){var e=parseInt(h.value);if(e<1){h.value=1}else{var a=h.id,p=h.value,n=this.getView().down("checkout"),q=0,s=n.up("checkoutwindow"),r=s.down("#valuepoints"),d=s.down("#orignalvalue"),o=n.getStore(),c=parseInt(Ext.getStore("login").getAt(0).getData().score.rewardpoints),l=0,g,b=Ext.create("Ext.window.Toast",{width:300,height:200,closeAction:"hide",html:"Success !",align:"t"}),f=parseInt(Ext.getStore("login").getAt(0).getData().score.rewardpoints),k=o.findRecord("id",a);if(o){for(i=0;i<o.getCount();i++){g=o.getAt(i).getData();l+=parseInt(g.points)}l-=parseInt(k.get("exactPoints"))*parseInt(k.get("qty"));l=l+(parseInt(k.get("exactPoints"))*parseInt(p));if(f<l){b.update("Points are less");b.show();h.value=k.get("qty");return}}if(parseInt(k.get("orignalqty"))<parseInt(p)){b.update("Out Of Stock");b.show();h.value=k.get("qty");return}k.set("qty",p);k.set("points",(parseInt(p)*parseFloat(k.get("exactPoints"))));for(j=0;j<o.getCount();j++){q+=parseInt(o.getAt(j).getData().points)}r.setText("Redeemed "+q);r.prize=q;d.setText("Available "+(c-q));d.prize=c-q}}});Ext.define("Redeem.product.CheckoutWindow",{extend:"Ext.window.Window",alias:"widget.checkoutwindow",requires:["Redeem.product.Checkout","Redeem.product.CheckoutWindowController"],width:"50%",height:"50%",autoShow:true,scrollable:true,resizable:false,maskClickAction:"hide",modal:true,title:"Checkout",titleAlign:"center",cls:"checkoutwindow",controller:"checkoutwindow",initComponent:function(){var a=this;this.dockedItems=this.buildTbar();this.bbar=this.buildBbar();this.items=this.buildItems();this.callParent(arguments);a.mon(Ext.getBody(),"click",function(b,c){a.close(a.closeAction)},a,{delegate:".x-mask"})},buildTbar:function(){return[{xtype:"toolbar",dock:"top",layout:{pack:"center"},items:[{xtype:"label",cls:"lbl-redeemed",itemId:"valuepoints",text:"Redeemed "+this.currentVal,prize:this.currentVal},{xtype:"label",cls:"lbl-available",itemId:"orignalvalue",text:"Available "+this.balanceVal,prize:this.balanceVal}]}]},buildBbar:function(){return["->",{text:"Cancel",cls:"btn-cancel",handler:function(){this.up("checkoutwindow").close()}},{text:"Confirm",cls:"btn-confirm",handler:"onConfirmBtnClick"}]},buildItems:function(){return[{xtype:"checkout",store:this.store}]}});Ext.define("Redeem.product.Product",{extend:"Ext.view.View",alias:"widget.product",cls:"redeem-product",emptyText:"No products available",tpl:['<tpl for=".">','<div class="product-wrap">','<div class="product-name">{[this.getNames(values)]}</div>','<img src="{[this.getImage(values)]}" class = "product-img" />','<div class="product-color">','<tpl for="attributeOptions.color">','<div class="color" style ="box-shadow: 1px 3px 10px #aeaeae; border-color:{.};"></div>',"</tpl>","</div>",'<div class="product-size">','<tpl for="attributeOptions.size">','<div class="size">{.}</div>',"</tpl>","</div>",'<div class="product-value">','<div class="value"><span class = "pointscls">P</span>{[this.getPoints(values)]}</div>','<div class="buy-btn">Buy</div>',"</div>","</div>","</tpl>",{getImage:function(a){if(Ext.isEmpty(a.image_url)){return"resources/images/redeem/comingsoon.jpg"}return a.image_url},getPoints:function(a){console.log("values: ",a);return parseInt(a.points)},getNames:function(a){return a.name}}],itemSelector:"div.product-wrap",listeners:{itemclick:"onItemClick"}});Ext.define("Redeem.product.ProductView",{extend:"Ext.panel.Panel",alias:"widget.productview",requires:["Redeem.product.Product","Redeem.product.CheckoutWindow"],cls:"redeem-product-view",bodyPadding:20,scrollable:true,height:550,dockedItems:[{xtype:"toolbar",dock:"top",items:[{xtype:"tbspacer",width:30},{xtype:"button",text:"",iconCls:"x-fa fa-google-wallet",cls:"redeem-wallet",disabled:true,bind:{text:"{rewardPoints}"}},"->",{bind:{text:"Checkout {badgeText}"},iconCls:"x-fa fa-shopping-cart",width:130,cls:"redeem-checkout",itemId:"Checkout_button",handler:"onClickCheckOut",disabled:true},{xtype:"tbspacer",width:27}]}],items:[{xtype:"product",reference:"product",bind:{store:"{productstore}"}}]});Ext.define("Redeem.store.AttributeJsonStore",{extend:"Ext.data.Store",alias:"store.attributejsonstore",autoLoad:false,fields:["name","value"],proxy:{type:"ajax",url:"resources/data/redeem/attributes.json",reader:{type:"json",rootProperty:"data"}}});Ext.define("Redeem.store.AttributeStore",{extend:"Ext.data.Store",alias:"store.attributestore",autoLoad:false,fields:["name","attribute_values","ddo_productattribute_id","code"],proxy:{type:"ajax",api:{read:"/productattribute",create:"/productattribute",update:"/productattribute",destroy:"/productattribute"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}}});Ext.define("Redeem.store.AttributeValueStore",{extend:"Ext.data.Store",alias:"store.attributevaluestore",autoLoad:false,fields:["ddo_productattribute_value_id","description","ddo_productattribute_id","productattribute","productattributevalue","code"],proxy:{type:"ajax",api:{read:"/productattributevalues",create:"/productattributevalues",update:"/productattributevalues",destroy:"/productattributevalues"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}},groupField:"productattribute"});Ext.define("Redeem.store.CategoryValueStore",{extend:"Ext.data.Store",alias:"store.categoryevaluestore",autoLoad:false,fields:["ddo_productcategory_id","description","productcategoryname","code"],proxy:{type:"ajax",api:{read:"/productcategory",create:"/productcategory",update:"/productcategory",destroy:"/productcategory"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}}});Ext.define("Redeem.store.ProductImagesStore",{extend:"Ext.data.Store",alias:"store.productimagesstore",autoLoad:false,idProperty:"ddo_product_images_id",fields:["imagepath","isdefault","ddo_product_images_id","ddo_product_id"],proxy:{type:"ajax",api:{read:"/productimage",create:"/productimage",update:"/productimage",destroy:"/productimage"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}}});Ext.define("Redeem.store.ProductValueStore",{extend:"Ext.data.Store",alias:"store.productvaluestore",autoLoad:false,fields:["ddo_product_id","categoryname","ddo_productcategory_id","price","quantity","code","productname"],proxy:{type:"ajax",api:{read:"/product",create:"/product",update:"/product",destroy:"/product"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}}});Ext.define("Redeem.store.SetAttributeStore",{extend:"Ext.data.Store",alias:"store.setattributestore",autoLoad:false,fields:["ddo_product_id","attribute_code","attribute_ids","attribute_value_ids","quantity","ddo_productattribute_id","ddo_productattributes_set_id","ddo_productattribute_instance_id"],proxy:{type:"ajax",api:{read:"/setproductattributes",create:"/setproductattributes",update:"/setproductattributes",destroy:"/setproductattributes"},actionMethods:{read:"GET",create:"POST",update:"PUT",destroy:"DELETE"},reader:{type:"json",rootProperty:"data"},writer:{writeAllFields:true}}});Ext.define("Redeem.view.RedeemViewController",{extend:"Ext.app.ViewController",alias:"controller.redeemview",onSelectionChange:function(d,g,m,e){var f=this,k=f.getView(),h=k.getReferences(),a=h.categorygrid,l=a.getStore(),c,b=[];c=l.getAt(g);if(!m){c.set("selected",true)}l.each(function(n){if(c.get("id")==n.get("id")){b.push(n.get("id"))}else{n.set("selected",false)}});f.filterProduct(b)},filterProduct:function(c){var b=this,a=b.getViewModel(),d=a.get("productstore");if(c.length==1&&c[0]==0){d.clearFilter(true);d.load();return}if(c.length!=0&&!Ext.Array.contains(c,1)){d.clearFilter(true);d.filterBy(function(e){return Ext.Array.contains(c,e.get("categoryId"))})}else{d.clearFilter(true);d.load()}},onItemClick:function(g,a,f,b,h,c){var d=h.getTarget().className;if(d=="size"){this.size={record:a,e:h,item:f.childNodes[3]};this.onClickSize(a,h,f.childNodes[3])}else{if(d=="color"){this.color={record:a,e:h,item:f.childNodes[2]};this.onClickColor(a,h,f.childNodes[2])}else{if(d=="buy-btn"){this.onClickBuy(a,h,f.childNodes[3],f.childNodes[2])}}}},onClickSize:function(a,d,b){var c=d.getTarget(),f=b.childNodes;Ext.Array.each(f,function(g,e,h){if(Ext.Array.contains(g.classList,"selected")){g.className="size";return false}});this.customSize=c.innerHTML;c.className=c.className+" selected"},onClickColor:function(a,d,b){var c=d.getTarget(),g=b.childNodes;Ext.Array.each(g,function(h,e,k){if(Ext.Array.contains(h.classList,"selected")){h.className="color";return false}});var f=c.outerHTML;index1=c.outerHTML.indexOf(":")+1;index2=c.outerHTML.indexOf(";");index3=index2-index1;cstr=f.substr(index1,index3);this.customColor=cstr;c.className=c.className+" selected"},onClickBuy:function(f,v,a,s){var h=this.getViewModel(),w=this,n=h.get("selectedItems"),d=a.childNodes,o=s.childNodes,b=false,g=false,u=true,y=false,p=0;Ext.Array.each(d,function(q,e,z){if(Ext.Array.contains(q.classList,"selected")){b=true;size=q.textContent}});Ext.Array.each(o,function(q,e,z){if(Ext.Array.contains(q.classList,"selected")){g=true}});var l=Ext.create("Ext.window.Toast",{width:200,closeAction:"hide",align:"t"});if(parseInt(f.data.quantity)===0){u=false;l.update("Out of Stock");l.show();return}if(f.data.attributeOptions.size.length===0||f.data.attributeOptions.color.length===0){b=true;g=true}if(b&&g){var k={attributeOptions:{size:this.buildSize(f.data.attributeOptions.size),color:this.buildColor(f.data.attributeOptions.color)},img:f.data.image_url,name:f.data.name,categoryId:f.data.categoryId,itemId:f.data.itemId,pid:f.data.id,points:parseInt(f.data.points),qty:1,exactPoints:parseInt(f.data.points),orignalqty:f.data.quantity};k.attributeOptions.size.forEach(function(e){if(!Ext.isEmpty(e.dispVal)&&e.dispVal===w.customSize){e.selected=" selected"}else{e.selected=""}});k.attributeOptions.color.forEach(function(e){if(!Ext.isEmpty(e.val)&&e.val===w.customColor){e.selected=" selected"}else{e.selected=""}});var t=parseInt(this.getViewModel().get("rewardPoints")),c=0;for(i=0;i<n.length;i++){c=c+parseFloat(n[i].points)}if(n.length>=1){c=c+parseFloat(k.points)}if(n.length==0){c=c+parseFloat(k.points)}if(c<=t){if(n.length==0){u=false;n.push(k)}else{for(i=0;i<n.length;i++){if(k.pid===n[i].pid){y=true;for(j=0;j<k.attributeOptions.size.length;j++){if(n[i].attributeOptions.size[j].dispVal===k.attributeOptions.size[j].dispVal&&(n[i].attributeOptions.size[j].selected===" selected"&&k.attributeOptions.size[j].selected===" selected")){var m=n[i].qty+1;if(parseInt(f.data.quantity)<m){u=false;l.update("Out of Stock");l.show();return}n[i].qty=m;n[i].points=parseFloat(f.data.points)*m;u=false}}}else{u=false}}if(!y){n.push(k)}}if(u){n.push(k)}h.set("selectedItems",n);h.set("itemsCount",n.length);h.set("badgeText",'<div class="btn-badge">'+n.length+"</div>");l.update("Added to your cart");l.show();var r=this.getView().down("#Checkout_button");if(r){r.setDisabled(false)}}else{l.update("Ponts is less");l.show()}if(!Ext.isEmpty(this.size)){var d=this.size.item.childNodes;Ext.Array.each(d,function(q,e,z){if(Ext.Array.contains(q.classList,"selected")){q.className="size";return false}});this.size=null}if(!Ext.isEmpty(this.color)){var d=this.color.item.childNodes;Ext.Array.each(d,function(q,e,z){if(Ext.Array.contains(q.classList,"selected")){q.className="color";return false}});this.color=null}}else{l.update("Please select the size and color");l.show()}},buildSize:function(a){var b=[];a.forEach(function(d,c){b.push({dispVal:d})});return b},buildColor:function(a){var b=[];a.forEach(function(d,c){b.push({val:d})});return b},onClickCheckOut:function(d){var c=this.getViewModel(),b=0,f=c.get("selectedItems"),a=Ext.create("Ext.data.Store",{data:f}),e=parseInt(this.getViewModel().get("rewardPoints"));f.forEach(function(g){b+=parseFloat(g.points)});Ext.create("Redeem.product.CheckoutWindow",{currentVal:b,balanceVal:(e-parseFloat(b)),store:a})},onCategoryGridRender:function(c,a){var b,d;b=this.getViewModel();d=b.getStore("categorystore");d.load({scope:this,callback:function(e,f,g){d.getAt(0).set("selected",true)}})}});Ext.define("Redeem.view.RedeemViewModel",{extend:"Ext.app.ViewModel",alias:"viewmodel.redeemview",data:{badgeText:null,currentVal:null,itemsCount:null,balanceVal:null,selectedItems:[],selectedSize:null,selectedColor:null},stores:{categorystore:{proxy:{type:"ajax",url:"/productcategories",reader:{type:"json",rootProperty:"category"}}},productstore:{proxy:{type:"ajax",url:"/products",method:"POST",extraParams:{productCategoryId:0},reader:{type:"json",rootProperty:"products"}},autoLoad:true}}});Ext.define("Redeem.view.RedeemView",{extend:"Ext.window.Window",alias:"widget.redeem-view",requires:["Redeem.category.CategoryView","Redeem.product.ProductView","Redeem.product.CheckoutWindow","Redeem.view.RedeemViewController","Redeem.view.RedeemViewModel"],controller:"redeemview",viewModel:{type:"redeemview"},width:"90%",height:580,modal:true,draggable:false,resizable:false,cls:"redeem-view",items:[{xtype:"container",width:"100%",height:"100%",layout:{type:"hbox"},items:[{xtype:"categoryview",flex:0.17},{xtype:"productview",flex:0.83}]}],initComponent:function(){var a=this;a.callParent(arguments);a.mon(Ext.getBody(),"click",function(b,c){a.close(a.closeAction)},a,{delegate:".x-mask"})}});